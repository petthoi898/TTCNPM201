<!doctype html>
<html lang="en">

<head>
  <title>Meal &mdash; Website Template by Colorlib</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link href="https://fonts.googleapis.com/css?family=Playfair+Display:300,400,700,800|Open+Sans:300,400,700"
    rel="stylesheet">

  <link rel="stylesheet" href="css/bootstrap.css">
  <link rel="stylesheet" href="css/animate.css">
  <link rel="stylesheet" href="css/owl.carousel.min.css">

  <link rel="stylesheet" href="css/magnific-popup.css">
  <link rel="stylesheet" href="css/aos.css">

  <link rel="stylesheet" href="css/bootstrap-datepicker.css">
  <link rel="stylesheet" href="css/jquery.timepicker.css">

  <link rel="stylesheet" href="fonts/ionicons/css/ionicons.min.css">
  <link rel="stylesheet" href="fonts/fontawesome/css/font-awesome.min.css">

  <link rel="stylesheet" href="fonts/flaticon/font/flaticon.css">

  <!-- Theme Style -->
  <link rel="stylesheet" href="css/style.css">
  <style>
    .product-image {
      float: left;
      width: 20%;
    }

    .product-details {
      float: left;
      width: 41%;
    }

    .product-amount {
      float: left;
      width: 5%;
    }

    .product-price {
      float: left;
      width: 8%;
    }

    .product-quantity {
      float: left;
      width: 10%;
    }

    .product-removal {
      float: left;
      width: 4%;
    }

    .product-line-price {
      float: left;
      width: 12%;
      text-align: right;
    }

    /* This is used as the traditional .clearfix class */
    .group:before,
    .shopping-cart:before,
    .column-labels:before,
    .product:before,
    .totals-item:before,
    .group:after,
    .shopping-cart:after,
    .column-labels:after,
    .product:after,
    .totals-item:after {
      content: '';
      display: table;
    }

    .group:after,
    .shopping-cart:after,
    .column-labels:after,
    .product:after,
    .totals-item:after {
      clear: both;
    }

    .group,
    .shopping-cart,
    .column-labels,
    .product,
    .totals-item {
      zoom: 1;
    }

    /* Apply clearfix in a few places */
    /* Apply dollar signs */
    .product .product-price:after,
    .product .product-line-price:after,
    .totals-value:after {
      content: ' đ';
    }

    /* Body/Header stuff */
    body {
      padding: 0px 30px 30px 20px;
      font-family: 'HelveticaNeue-Light', 'Helvetica Neue Light', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 100;
    }

    h1 {
      font-weight: 100;
    }

    label {
      color: #aaa;
    }

    .shopping-cart {
      margin-top: -45px;
    }

    /* Column headers */
    .column-labels label {
      padding-bottom: 15px;
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .column-labels .product-image,
    .column-labels .product-details,
    .column-labels .product-removal {
      text-indent: -9999px;
    }

    /* Product entries */
    .product {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .product .product-image {
      text-align: center;
    }

    .product .product-image img {
      width: 100px;
    }

    .product .product-details .product-title {
      margin-right: 20px;
      font-family: 'HelveticaNeue-Medium', 'Helvetica Neue Medium';
    }

    .product .product-details .product-description {
      margin: 5px 20px 5px 0;
      line-height: 1.4em;
    }

    .product .product-quantity input {
      width: 60px;
    }

    .product .remove-product {
      border: 0;
      padding: 4px 8px;
      background-color: #c66;
      color: #fff;
      font-family: 'HelveticaNeue-Medium', 'Helvetica Neue Medium';
      font-size: 12px;
      border-radius: 3px;
    }

    .product .remove-product:hover {
      background-color: #a44;
    }

    /* Totals section */
    .totals .totals-item {
      float: right;
      clear: both;
      width: 100%;
      margin-bottom: 10px;
    }

    .totals .totals-item label {
      float: left;
      clear: both;
      width: 79%;
      text-align: right;
    }

    .totals .totals-item .totals-value {
      float: right;
      width: 21%;
      text-align: right;
    }

    .totals .totals-item-total {
      font-family: 'HelveticaNeue-Medium', 'Helvetica Neue Medium';
    }

    .checkout {
      float: right;
      border: 0;
      margin-top: 20px;
      padding: 6px 25px;

      color: #fff;
      font-size: 25px;
      border-radius: 3px;
    }

    .checkout:hover {
      background-color: rgb(255, 68, 10);
    }

    /* Make adjustments for tablet */
    @media screen and (max-width: 650px) {
      .shopping-cart {
        margin: 0;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .column-labels {
        display: none;
      }

      .product-image {
        float: right;
        width: auto;
      }

      .product-image img {
        margin: 0 0 10px 10px;
      }

      .product-details {
        float: none;
        margin-bottom: 10px;
        width: auto;
      }

      .product-price {
        clear: both;
        width: 75px;
      }

      .product-quantity {
        width: 100px;
      }

      .product-quantity input {
        margin-left: 20px;
      }

      .product-amount:before {
        content: 'stock:';
      }

      .product-removal {
        width: auto;
      }

      .product-line-price {
        float: right;
        width: 75px;
      }
    }

    /* Make more adjustments for phone */
    @media screen and (max-width: 350px) {
      .product-removal {
        float: right;
      }

      .product-line-price {
        float: right;
        clear: left;
        width: auto;
        margin-top: 10px;
      }

      .product .product-line-price:before {
        content: 'Item Total: $';
      }

      .totals .totals-item label {
        width: 60%;
      }

      .totals .totals-item .totals-value {
        width: 40%;
      }

    }

    /* Noti */

    .top-left {
      position: fixed;
      z-index: 1000;
      display: flex;
      align-items: center;
      padding: 20px;
      color: #fff;
      line-height: 1.3;
      box-shadow: 0 0 15px 0 rgba(0, 0, 0, 0.35);
      max-width: 350px;
      margin: 20px;
      top: 0;
      left: 0;
      transform: translateX(-420px);
    }

    .top-left.do-show {
      animation: slide-in-left 1s ease-in-out forwards, slide-in-left 1s ease-in-out reverse forwards 5s;
    }

    .top-left[data-notification-status="notice"] {
      background-color: #29b6f6;
    }

    .top-left[data-notification-status="notice"]:before {
      content: '';
      display: block;
      width: 30px;
      height: 30px;
      min-width: 30px;
      margin-right: 20px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath d='M12 3.984c4.407 0 8.016 3.609 8.016 8.016 0 4.406-3.608 8.016-8.016 8.016S3.984 16.407 3.984 12 7.593 3.984 12 3.984m0-2C6.478 1.984 1.984 6.477 1.984 12c0 5.521 4.493 10.016 10.016 10.016S22.016 17.522 22.016 12c0-5.523-4.495-10.016-10.016-10.016zm0 2c4.407 0 8.016 3.609 8.016' fill='%23077CB1'/%3E%3Cpath d='M11.016,6.984V9h1.968V6.984H11.016z M11.016,17.016h1.968v-6h-1.968V17.016z' fill='%23077CB1'/%3E%3C/svg%3E") center / cover no-repeat;
    }

    .top-left[data-notification-status="warning"] {
      background-color: #ffca28;
    }

    .top-left[data-notification-status="warning"]:before {
      content: '';
      display: block;
      width: 30px;
      height: 30px;
      min-width: 30px;
      margin-right: 20px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath d='M12 3.984c4.407 0 8.016 3.609 8.016 8.016 0 4.406-3.608 8.016-8.016 8.016S3.984 16.407 3.984 12 7.593 3.984 12 3.984m0-2C6.478 1.984 1.984 6.477 1.984 12c0 5.521 4.493 10.016 10.016 10.016S22.016 17.522 22.016 12c0-5.523-4.495-10.016-10.016-10.016zm0 2c4.407 0 8.016 3.609 8.016' fill='%23C19100'/%3E%3Cpath d='M11.016,17.016h1.968V15h-1.968V17.016z M11.016,6.983v6.001h1.968V6.983H11.016z' fill='%23C19100'/%3E%3C/svg%3E") center / cover no-repeat;
    }

    .top-left[data-notification-status="error"] {
      background-color: #ef5350;
    }

    .top-left[data-notification-status="error"]:before {
      content: '';
      display: block;
      width: 30px;
      height: 30px;
      min-width: 30px;
      margin-right: 20px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath d='M12 3.984c4.407 0 8.016 3.609 8.016 8.016 0 4.406-3.608 8.016-8.016 8.016S3.984 16.407 3.984 12 7.593 3.984 12 3.984m0-2C6.478 1.984 1.984 6.477 1.984 12c0 5.521 4.493 10.016 10.016 10.016S22.016 17.522 22.016 12c0-5.523-4.495-10.016-10.016-10.016zm0 2c4.407 0 8.016 3.609 8.016' fill='%23C61512'/%3E%3Cpath d='M13.406,12l2.578,2.578l-1.406,1.406L12,13.406l-2.578,2.578l-1.406-1.406L10.594,12L8.016,9.421l1.406-1.405L12,10.593 l2.578-2.577l1.406,1.405L13.406,12z' fill='%23C61512'/%3E%3C/svg%3E") center / cover no-repeat;
    }

    .top-left[data-notification-status="success"] {
      background-color: #66bb6a;
    }

    .top-left[data-notification-status="success"]:before {
      content: '';
      display: block;
      width: 30px;
      height: 30px;
      min-width: 30px;
      margin-right: 20px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath d='M12 3.984c4.407 0 8.016 3.609 8.016 8.016 0 4.406-3.608 8.016-8.016 8.016S3.984 16.407 3.984 12 7.593 3.984 12 3.984m0-2C6.478 1.984 1.984 6.477 1.984 12c0 5.521 4.493 10.016 10.016 10.016S22.016 17.522 22.016 12c0-5.523-4.495-10.016-10.016-10.016zm0 2c4.407 0 8.016 3.609 8.016' fill='%2339813C'/%3E%3Cpath d='M10.477,13.136l5.085-5.085l1.406,1.406l-6.492,6.492l-3.446-3.445l1.406-1.406L10.477,13.136z' fill='%2339813C'/%3E%3C/svg%3E") center / cover no-repeat;
    }

    .top-left[data-notification-status="question"] {
      background-color: #8d6e63;
    }

    .top-left[data-notification-status="question"]:before {
      content: '';
      display: block;
      width: 30px;
      height: 30px;
      min-width: 30px;
      margin-right: 20px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath d='M12 3.984c4.407 0 8.016 3.609 8.016 8.016 0 4.406-3.608 8.016-8.016 8.016S3.984 16.407 3.984 12 7.593 3.984 12 3.984m0-2C6.478 1.984 1.984 6.477 1.984 12c0 5.521 4.493 10.016 10.016 10.016S22.016 17.522 22.016 12c0-5.523-4.495-10.016-10.016-10.016zm0 2c4.407 0 8.016 3.609 8.016' fill='%23513F38'/%3E%3Cpath d='M12.001,6.314h-0.002c-1.996,0-3.609,1.614-3.609,3.609h1.784c0-0.977,0.85-1.784,1.826-1.784 c0.977,0,1.827,0.807,1.827,1.784c0,1.826-2.718,1.614-2.718,4.544h1.784c0-2.038,2.717-2.294,2.717-4.544 C15.609,7.928,13.997,6.314,12.001,6.314z M11.109,17.186h1.784v-1.826h-1.784V17.186z' fill='%23513F38'/%3E%3C/svg%3E") center / cover no-repeat;
    }

    .top-left[data-notification-status="plain"] {
      background-color: #333;
    }
  </style>
  </head>

<body class="bg-light">

  <body data-spy="scroll" data-target="#ftco-navbar-spy" data-offset="0">
    <div class="notify bar-top do-show" data-notification-status="success"></div>
    <div class="site-wrap">
      <!-- nav bar -->
      <%- include("function/navbar.ejs") %>



      <div class="section pb-3 bg-white" id="section-naptien" data-aos="fade-up">
        <div class="container">
          <div class="row align-items-center justify-content-center">
            <div class="col-md-12 col-lg-8 section-heading">


              <!-- menu foods start -->




            </div>
          </div>
        </div>
      </div>

      <div class="col-12" id="col123">
        <p class=""
          style="margin: auto; width: 50%;font-weight: bold; background-color: #EF534F; color: white; text-align: center;"
          id="status1"><%- status %></p>
      </div>
      <h1>Giỏ hàng</h1>

      <div class="shopping-cart">

        <div class="column-labels">
          <label class="product-image">Image</label>
          <label class="product-details">Product</label>
          <label class="product-amount">Stock</label>
          <label class="product-price">Price</label>

          <label class="product-quantity">Quantity</label>
          <label class="product-removal">Remove</label>
          <label class="product-line-price">Total</label>
        </div>

        <!-- San pham start -->
        <% data.forEach(element => { %>
        <div class="product">
          <div class="product-image">
            <img src="/uploads/foods/<%= element.image %>">
          </div>
          <div class="product-details">
            <div class="product-title"> <%= element.title %></div>
            <p class="product-description"><%= element.description %></p>
          </div>
          <div class="product-amount"><%= element.amount %></div>
          <div class="product-price"><%= element.price %></div>

          <div class="product-quantity">
            <input type="number" value="<%= element.soluong %>" id="<%= element.id %>"
              onchange=" <%= 'a' + element.id %>() " min="1">
          </div>
          <div class="product-removal">
            <button id=" <%= element.id %>" class="remove-product">
              Xóa
            </button>
          </div>
          <div class="product-line-price"><%= element.price*element.soluong %></div>
        </div>

        <% }) %>
        <!-- San pham end -->

        <div class="totals" style="padding-bottom: 10%;">

          <div class="totals-item totals-item-total">
            <label id="totalprice">
            </label>
            <div class="totals-value" id="cart-total">0</div>
          </div>
          <button class="btn btn-primary checkout">Thanh toán</button>

        </div>


      </div>
      <%- include("function/footer.ejs") %>
      <script>
        var a = 0;

<% data.forEach(element => { %>
          function <%= 'a' + element.id %> (params) {
            var id =  <%=  element.id %>;
            var soluong = document.getElementById("<%= element.id %>").value;
            var data = { id: id, soluong: soluong }
            ajaxsend(data);

          }

          a += <%= element.price * element.soluong %> ;
  <% }) %>

          function ajaxsend(params) {
            let data = params;
            $.ajax({
              type: 'post',
              url: '/capnhatgiohang',
              data: data, success: function (result) {
                if (result == "Số lượng món ăn phải lớn hơn 0") {
                  $("#status").html(result);
                  document.getElementsByName('amount').value = '';
                  myVar = setTimeout(function name(params) {

                    $("#status").html("");

                  }, 3000);

                } else if (result == "Số lượng món ăn không hợp lệ") {
                  $("#status").html(result);
                  document.getElementsByName('amount').value = '';
                  myVar = setTimeout(function name(params) {

                    $("#status").html("");

                  }, 3000);

                } else if (result == "Số lượng món ăn trong quầy không đủ") {
                  $("#status").html(result);
                  document.getElementsByName('amount').value = '';
                  myVar = setTimeout(function name(params) {

                    $("#status").html("");

                  }, 3000);

                }
              }

            });
          };


        $('.totals-value').html(a);
        /* Set rates + misc */
        var taxRate = 0;
        var shippingRate = 0;
        var fadeTime = 0;


        /* Assign actions */
        $('.product-quantity input').change(function () {
          updateQuantity(this);
        });

        $('.product-removal button').click(function () {
          var id = this.id;
          console.log(id);

          $.ajax({
            type: 'post',
            url: '/xoasanphamtronggiohang',
            data: { id: id }

          });

          removeItem(this);
        });


        /* Recalculate cart */
        function recalculateCart() {
          var subtotal = 0;

          /* Sum up row totals */
          $('.product').each(function () {
            subtotal += parseFloat($(this).children('.product-line-price').text());
          });

          /* Calculate totals */
          var tax = subtotal * taxRate;
          var shipping = (subtotal > 0 ? shippingRate : 0);
          var total = subtotal + tax + shipping;

          /* Update totals display */
          $('.totals-value').fadeOut(fadeTime, function () {
            $('#cart-subtotal').html(subtotal);
            $('#cart-tax').html(tax);
            $('#cart-shipping').html(shipping);
            $('#cart-total').html(total);
            if (total == 0) {
              $('.checkout').fadeOut(fadeTime);
            } else {
              $('.checkout').fadeIn(fadeTime);
            }
            $('.totals-value').fadeIn(fadeTime);
          });
        }

        /* Update quantity */
        function updateQuantity(quantityInput) {
          /* Calculate line price */
          var productRow = $(quantityInput).parent().parent();
          var price = parseFloat(productRow.children('.product-price').text());
          var quantity = $(quantityInput).val();
          var linePrice = price * quantity;

          /* Update line price display and recalc cart totals */
          productRow.children('.product-line-price').each(function () {
            $(this).fadeOut(fadeTime, function () {
              $(this).text(linePrice);
              recalculateCart();
              $(this).fadeIn(fadeTime);
            });
          });
        }
        // jQuery

        /* Remove item from cart */
        function removeItem(removeButton) {

          /* Remove row from DOM and recalc cart total */
          var productRow = $(removeButton).parent().parent();
          productRow.slideUp(fadeTime, function () {
            productRow.remove();
            recalculateCart();
          });
        }
        $('.checkout').click(function (params) {
          $.ajax({
            type: 'post',
            url: '/thanhtoan',
            data: { id: 'thanhtoan' }
            , success: function (result) {
              if (result == 'success') {
                $("#status").html('Đặt hàng thành công');
                document.getElementsByName('amount').value = '';
                myVar = setTimeout(function name(params) {

                  $("#status").html("");

                }, 3000);

                $('.shopping-cart').remove();
              } else if (result == 'nem') {
                $("#status").html('Tài khoản không đủ tiền');
                document.getElementsByName('amount').value = '';
                myVar = setTimeout(function name(params) {

                  $("#status").html("");

                }, 3000);
              } else if (result == 0) {
                $("#status").html('Không có gì để thanh toán');
                document.getElementsByName('amount').value = '';
                myVar = setTimeout(function name(params) {

                  $("#status").html("");

                }, 3000);
              } else {
                console.log(result);
                var textResult = "";
                result.forEach(element => {
                  console.log(element);

                  textResult += "<p> Chỉ còn " + element.amount + " " + element.tenmon + " trong quầy.  </p> ";
                })
                textResult += "<p> Vui lòng chọn lại số lượng.</p> "

                $("#status1").append(textResult);
                document.getElementsByName('amount').value = '';


              }


            }
          });
        })
      </script>
      <%- include('function/js/noti') %>
  </body>

</html>